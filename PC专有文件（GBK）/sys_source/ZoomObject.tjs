//------------------------------------------------------------------------------
// Note : BASE ADV SYSTEM
// Data : 2010/07/22
// File : ZoomObject.tjs
// Creator : Kazuyuki Uchino
// Memo : Utility Function
//------------------------------------------------------------------------------
@if (__ZOOMOBJECT_TJS__== 0)
@set(__ZOOMOBJECT_TJS__ = 1)

/*
	±³¾°/Ç°¾°»­Ïñ¤Î’ˆ´ó¿sĞ¡„¿¹û¤Ë¤è¤ë±íÊ¾¤òĞĞ¤¦¥×¥é¥°¥¤¥ó
*/

class _ZOOMOBJECT 
{	
	var MainWnd;//Window ¥ª¥Ö¥¸¥§¥¯¥È
	var PriLayer;//¥×¥é¥¤¥Ş¥ê¥ì¥¤¥ä
	var tempLayer; // ¥Æ¥ó¥İ¥é¥ê¥ì¥¤¥ä
	
	var sl, st, sw, sh;
	var dl, dt, dw, dh;
	var startTick; // é_Ê¼¥Æ¥£¥Ã¥¯
	var time; // ¥º©`¥à¤òĞĞ¤Ã¤Æ¤¤¤ë•rég
	var mode; // Ç°¾°¥ì¥¤¥ä¥â©`¥É
	var accel; // ¼ÓËÙ¶ÈµÄ¤Ê„Ó¤­¤òĞĞ¤¦¤« ( Ø“ : 0 : Õı )
	var moving = false;
	var nextstop;
	var moveFunc; // ÒÆ„ÓÎ»ÖÃÓ‹ËãÓÃévÊı
	var targetLayerName; // ŒÏó¥ì¥¤¥äÃû
	var targetLayer; // ŒÏó¥ì¥¤¥ä
	var zoomtype;	//zoom type (0:stNeares 1:stFastLinear 2:stLinear)
	
	
	
	
	
	
	
	/*-----------------------------------------
	¡ö¥³¥ó¥¹¥È¥é¥¯¥¿
	-----------------------------------------*/
	function _ZOOMOBJECT(main, pri)
	{
		MainWnd = main;
		
		PriLayer= pri;
	}
	
	
	
	
	
	/*-----------------------------------------
	¡ö ¥Ç¥¹¥È¥é¥¯¥¿
	-----------------------------------------*/
	function finalize()
	{
		// finalize ¥á¥½¥Ã¥É
		// ¤³¤Î¥¯¥é¥¹¤Î¹ÜÀí¤¹¤ë¤¹¤Ù¤Æ¤Î¥ª¥Ö¥¸¥§¥¯¥È¤òÃ÷Ê¾µÄ¤ËÆÆ—‰
		stop();
		
		if (tempLayer !== null){
			invalidate tempLayer;
		}
		
		tempLayer = void;
		
		//¥¬¥Ù©`¥¸¤òŠÖÆµÄ¤Ë„Ó¤«¤¹
		System.doCompact();
		
	}
	
	
	
	
	/*-----------------------------------------
	¡ô¥¤¥Ù¥ó¥ÈÈ¡µÃévÊı
	
	ÒıÊı£º
	¤Ê¤·
	
	ÕhÃ÷£º
	Mouse Up¤ò„IÀí¤¹¤ë¥Ï¥ó¥É¥é
	
	-----------------------------------------*/
	function LeftMouseUpAction()
	{
		//½KÁË„IÀí
		finish();
	}
	
	
	
	
	
	
	/*-----------------------------------------
	¡ö £Ú£Ï£Ï£Í é_Ê¼
	-----------------------------------------*/
	function startZoom(layer, basestorage, sl, st, sw, sh, dl, dt, dw, dh, time, accel)
	{
		// layer : ŒÏó¥ì¥¤¥ä
		// sl st sw sh : ³õÆÚÎ»ÖÃ
		// dl dt dw dh : ×î½KÎ»ÖÃ
		// time : ¥º©`¥à¤òĞĞ¤Ã¤Æ¤¤¤ë•rég
		// accel : ¼ÓËÙ¤ò¤Ä¤±¤ë¤«¤É¤¦¤«

		// ¼È´æ¤Î„Ó×÷¤òÍ£Ö¹
		stop();

		// ŒÏó¥ì¥¤¥ä¤ò›Q¶¨
		targetLayer = layer;

		// ±³¾°»­Ïñ¤ÎÕi¤ßŞz¤ß
		if(basestorage !== void){
			targetLayer.loadImages(basestorage);
			
			targetLayer.setSizeToImageSize();
		}
		
		// ¥ª¥Ö¥¸¥§¥¯¥È¤Ë¥Ñ¥é¥á©`¥¿¤ò¥³¥Ô©`
		this.sl = sl; this.st = st; this.sw = sw; this.sh = sh;
		this.dl = dl; this.dt = dt; this.dw = dw; this.dh = dh;
		this.time  = time;
		this.accel = accel;
		this.targetLayerName = layer;
		this.mode = mode;

		// tempLayer ´_±£
		if(tempLayer === void)
		{
			tempLayer = new Layer(MainWnd, PriLayer);
		}
		
		
		if(basestorage !== void){
			
			tempLayer.loadImages(basestorage);
			
			tempLayer.setSizeToImageSize();
		}else{
		//¥Õ¥¡¥¤¥ëÖ¸¶¨¤¬Ÿo¤¤ˆöºÏ¤Ï¬F×´¤Î¥ì¥¤¥ä¤ò¥Æ¥ó¥İ¥é¥ê¤Ë¤¹¤ë
			tempLayer.setImageSize(targetLayer.width, targetLayer.height);
			
			tempLayer.copyRect(0,0,targetLayer, 0,0,targetLayer.width, targetLayer.height);
		}
		
		
		
		//ŒÏó¥ì¥¤¥ä¤¬×î½K¾ØĞÎ¤è¤êĞ¡¤µ¤¤ˆöºÏ¤Ï´ó¤­¤¯¤·¤Æ¤ª¤¯
		if(layer.imageWidth < dw)layer.imageWidth   = dw;
		
		if(layer.imageHeight < dh)layer.imageHeight = dh;
		
		
		tempLayer.absolute = targetLayer.absolute + 1;
		
		// ÒÆ„ÓÎ»ÖÃÓ‹ËãévÊı¤ÎÔO¶¨
		moveFunc = defaultMover;
		
		// ³õÆÚÎ»ÖÃ¤Ë±íÊ¾
		moveFunc(moveAt, 0);
		
		
		// é_Ê¼
		startTick = System.getTickCount();
		
		System.addContinuousHandler(continuousHandler);
		
		moving = true;
		
		nextstop = false;
	}
	
	
	
	
	
	
	/*-----------------------------------------
	¡ö »­ÏñÒÆ„Ó
	-----------------------------------------*/
	function moveAt(l, t, w, h)
	{
		// l t w h Î»ÖÃ¤ËÒÆ„Ó

		// ¥ì¥¤¥äÒÆ„Ó
		var base = targetLayer;
		
		var oll = l < 0 ? 0 : l;
		
		var olt = t < 0 ? 0 : t;
		
		var olw = l + w > base.imageWidth ? base.imageWidth - oll : l + w - oll;
		
		var olh = t + h > base.imageHeight ? base.imageHeight - olt : t + h - olt;
		
		if(
			((isvalid base) == true) &&
			(olw > 0 && olh > 0)
		){
			base.visible = true;
			
			//base.setPos(oll, olt, olw, olh);
			
			var dleft = ((l - oll) < 0) ? 0 : (l - oll);
			var dtop  = ((t - olt) < 0) ? 0 : (t - olt);
			
			var type = 0;
			
			switch(zoomtype){
				case 0:{//0:stNeares
					type = stNearest;
				}break;
				case 1:{//1:stFastLinear
					type = stFastLinear;
				}break;
				case 2:{//2:stLinear
					type = stLinear;
				}break;
			}
			
			// ’ˆ´ó¿sĞ¡ÜËÍ
			base.stretchCopy(dleft, dtop, w, h, tempLayer, 0, 0, tempLayer.imageWidth, tempLayer.imageHeight, type);
			// ÒÆ„ÓÏÈ¤¬ÓÒ¤äÏÂ¤Ë¤Ï¤ß³ö¤ëˆöºÏ¤Ë¤Á¤ç¤Ã¤ÈŸoñj¤ÊÜËÍ¤¬Æğ¤³¤ë¤«¤â
			
			base.setPos(l, t, w, h);
		}
		
		
	}
	
	
	
	
	
	
	/*-----------------------------------------
	¡öÎ»ÖÃÓ‹Ëã
	-----------------------------------------*/
	function defaultMover(func, tm)
	{
		// Î»ÖÃÓ‹Ëã
		// tm ¤Ï 0.0(é_Ê¼µã) ¡« 1.0(½KÁËµã) ¤Îég¤Ç‰ä»¯¤¹¤ë‰äÊı¤Ê¤Î¤Ç¡¢
		// ¤³¤ì¤òÔª¤Ë¤·¤ÆÎ»ÖÃ¤òÓ‹Ëã¤¹¤ë
		var l = (int)((dl - sl) * tm + sl);
		var t = (int)((dt - st) * tm + st);
		var w = (int)((dw - sw) * tm + sw);
		var h = (int)((dh - sh) * tm + sh);

		// ÒÆ„Ó
		func(l, t, w, h);
	}
	
	
	
	
	
	
	/*-----------------------------------------
	¡ö ¥ë©`¥×¥Ï¥ó¥É¥é
	-----------------------------------------*/
	function continuousHandler(tick)
	{
		// ¥Ï¥ó¥É¥é
		if(nextstop)
		{
			// ½KÁË
			finish();
			return;
		}

		// •rég¤òµÃ¤ë
		var tm = tick - startTick;
		
		tm /= time;
		
		if(tm >= 1)
		{
			nextstop = true;
			tm = 1;
		}
		else
		{
			// ¼ÓËÙÓ‹Ëã
			if(accel < 0)
			{
				// ÉÏÏÒ ( ×î³õ¤¬„Ó¤­¤¬Ôç¤¯¡¢Ğì¡©¤ËßW¤¯¤Ê¤ë )
				tm = 1.0 - tm;
				tm = Math.pow(tm, -accel);
				tm = 1.0 - tm;
			}
			else if(accel > 0)
			{
				// ÏÂÏÒ ( ×î³õ¤Ï„Ó¤­¤¬ßW¤¯¡¢Ğì¡©¤ËÔç¤¯¤Ê¤ë )
				tm = Math.pow(tm, accel);
			}
		}
		
		
		// ÒÆ„Ó
		moveFunc(moveAt, tm);
	}
	
	
	
	
	
	
	/*-----------------------------------------
	¡ö½KÁËévÊı
	-----------------------------------------*/
	function finish()
	{
		// ¥º©`¥à¤Î½KÁË
		moveAt(dl, dt, dw, dh);
		
		targetLayer.update();
		
		stop(); // Í£Ö¹
	}
	
	
	
	
	
	/*-----------------------------------------
	¡ö ½KÁË„IÀí
	-----------------------------------------*/
	function stop()
	{
		// Í£Ö¹
		if(moving)
		{
			System.removeContinuousHandler(continuousHandler);
			
			moving = false;
		}
		
		if( tempLayer !== null){
			invalidate tempLayer;
		}
		
		tempLayer    = void;
		
		targetLayer  = void;
		
		//¥¬¥Ù©`¥¸¤òŠÖÆµÄ¤Ë„Ó¤«¤¹
		System.doCompact();
		
	}
}


@endif

);
		
		targetLayer.update();
		
		stop(); // åœæ­¢
	}
	
	
	
	
	
	/*-----------------------------------------
	â–  çµ‚äº†å‡¦ç†
	-----------------------------------------*/
	function stop()
	{
		// åœæ­¢
		if(moving)
		{
			System.removeContinuousHandler(continuousHandler);
			
			moving = false;
		}
		
		if( tempLayer !== null){
			invalidate tempLayer;
		}
		
		tempLayer    = void;
		
		targetLayer  = void;
		
		//ã‚¬ãƒ™ãƒ¼ã‚¸ã‚’å¼·åˆ¶çš„ã«å‹•ã‹ã™
		System.doCompact();
		
	}
}


@endif

