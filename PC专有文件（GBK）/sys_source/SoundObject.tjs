//------------------------------------------------------------------------------
// Note : BASE ADV SYSTEM
// Data : 2010/05/14
// File : SoundObject.tjs
// Creator : Kazuyuki Uchino
// Memo : SoundObject
//------------------------------------------------------------------------------
@if (__SOUNDOBJECT_TJS__== 0)
@set(__SOUNDOBJECT_TJS__ = 1)

class _SOUNDOBJECT extends WaveSoundBuffer, BaseObject {
	
	/*-----------------------------------------
	¡ö ¥Ñ¥é¥á©`¥¿
	-----------------------------------------*/
	var MainWnd;		//MainObject
	
	var soundtype;		//SOUND ·N„e
	
						//bgm¡¡se¡¡voice¡¡movie
	
	var FadeStopflag;	//Fade¥Õ¥é¥°
	
	var WaitTimer;		//Wait ¥¿¥¤¥Ş©`¥ª¥Ö¥¸¥§¥¯¥È
	
	var WaitParam = %[];//WaitÓÃ¥Ñ¥é¥á©`¥¿
	
	var labelFlag;		//¥é¥Ù¥ë¥Õ¥é¥°
	
	var ResFile;		//¥ê¥½©`¥¹¥Õ¥¡¥¤¥ëÃû
	
	
	
	
	
	
	
	/*-----------------------------------------
	¡ö ¥³¥ó¥¹¥È¥é¥¯¥¿
	-----------------------------------------*/
	function _SOUNDOBJECT(type, obj)
	{
		MainWnd   = obj;
		
		soundtype = type;
		
		WaveSoundBuffer(this);
		
		BaseObject(obj, obj.PrimaryLayer);
		
		labelFlag = false;
		
		
		//¥Ü¥ê¥å©`¥àÔO¶¨
		volume2 = 100000;
		
		//type¤Ë¤è¤Ã¤Æ·Ö¤«¤ì¤ë
		if(type == "bgm"){
			volume  = MainWnd.SoundObj.BgmVolume   * 1000;
		}else if(type == "se"){
			volume  = MainWnd.SoundObj.SeVolume    * 1000;
		}else if(type == "voice"){
			volume  = MainWnd.SoundObj.VoiceVolume * 1000;
		}else if(type == "system_se"){
			volume  = MainWnd.SoundObj.SystemVolume* 1000;
		}else if(type == "movie"){
			volume  = MainWnd.SoundObj.MovieVolume * 1000;
		}
	}
	
	
	
	
	
	
	/*-----------------------------------------
	¡õ¥Õ¥¡¥¤¥Ê¥é¥¤¥º
	
	ÒıÊı£º
	¤Ê¤·
	
	-----------------------------------------*/
	function finalize()
	{
		global.WaveSoundBuffer.finalize(...);
		
		global.BaseObject.finalize(...);
		
		//¥¬¥Ù©`¥¸¤òŠÖÆµÄ¤Ë„Ó¤«¤¹
		System.doCompact();
	}
	
	
	
	
	
	/*-----------------------------------------
	¡õ ¥Õ¥§©`¥É½KÁËévÊı
	-----------------------------------------*/
	function onFadeCompleted()
	{
		if(FadeStopflag)
		{
			//¥Õ¥§©`¥É½KÁË¥Õ¥é¥°¤òÇŞ¤«¤¹
			FadeStopflag = false;
			
			stop();
			
			ResFile = void;
			
			paused = false;
		}
	}
	
	
	
	
	
	/*-----------------------------------------
	¡ô¥¤¥Ù¥ó¥ÈÈ¡µÃévÊı
	
	ÒıÊı£º
	¤Ê¤·
	
	ÕhÃ÷£º
	¥é¥Ù¥ëÍ¨ß^•r¤Ë°kÉú¤¹¤ë¥¤¥Ù¥ó¥È
	
	-----------------------------------------*/
	function onLabel( name )
	{
		if(
			(s["voice_mask"] == true) &&
			(( name == "mute_on") || ( name == "mute_off"))
		){
			if(name == "mute_on"){
			//¥ß¥å©`¥È
				volume = 0;
			}else{
			//½â³ı
				volume  = MainWnd.SoundObj.VoiceVolume * 1000;
			}
		}else{
			labelFlag = name;
		}
	}
	
	
	
	
	
	
	/*-----------------------------------------
	¡ô¥¤¥Ù¥ó¥È±OÒ•évÊı
	
	ÒıÊı£º
	¤Ê¤·
	
	ÕhÃ÷£º
	¥é¥Ù¥ëÍ¨ß^•r¤Ë°kÉú¤¹¤ë¥¤¥Ù¥ó¥È¤ò±OÒ•¤¹¤ë
	
	-----------------------------------------*/	
	function Checklabelfunc()
	{
		if(labelFlag != false)
		{
			//¥Õ¥é¥°¤ò¥¯¥ê¥¢
			labelFlag = false;
			
			//±OÒ•ŒÏó¤«¤é¤³¤ÎévÊı¤òÍâ¤¹
			System.removeContinuousHandler(Checklabelfunc);
			
			//´Î¤Î¥¿¥°¤òÈ¡µÃ¤·¤Ë¤¤¤¯
			MainWnd.PaserObj.GetTagload();
		}
		
	}
	
	
	
	
	
	
	
	
	/*-----------------------------------------
	¡ñplayévÊı
	
	ÒıÊı£º
	
	file	ÔÙÉú¤¹¤ë¥Õ¥¡¥¤¥ëÃû(’ˆˆ×Ó¸¶¤­)
	
	
	ÕhÃ÷£º
	
	¥Õ¥¡¥¤¥ë¤òÔÙÉú¤·¤Ş¤¹
	
	-----------------------------------------*/
	function FilePlay(file, mode = false, time = false, waittime = false)
	{
		
		//¥ê¥½©`¥¹´_ÕJ
		if(ResourceCheck(file + ".ogg")){
			file += ".ogg";
		}else if(ResourceCheck(file + ".wav")){
			file += ".wav";
		}else if(!ResourceCheck(file)){
			//¥ê¥½©`¥¹—ÊË÷
			if (InforFlag == true) {
				DebugMess(file + "¤¬¤¢¤ê¤Ş¤»¤ó¤Ç¤·¤¿");
				return;
			}
		}
		
		
		//FileOpen
		if(
			(!ResourceCheck(file)) &&
			(!ResourceCheck(file + ".ogg")) &&
			(!ResourceCheck(file + ".wav"))
		){
			//¥ê¥½©`¥¹Ÿo¤·
			if (InforFlag == true) {
				DebugMess(file + " ¤¬ÒŠ¤Ä¤«¤ê¤Ş¤»¤ó");
			}
			
			return;
		}
		
		
		//¥Õ¥§©`¥Éstop¤Î×îÖĞ¤Ê¤é¤³¤³¤Ç½KÁË
		if(FadeStopflag){
			stopFade();
			stop();
			ResFile = void;
			paused = false;
			FadeStopflag = false;
		}
		
		
		//WaitObject¤ò³õÆÚ»¯¤·¤Æ¤ª¤¯
		WaitTimer = void;
		
		//¥é¥Ù¥ë¥Õ¥é¥°¤òÇŞ¤«¤»¤Æ¤ª¤¯
		labelFlag = false;
		
		if(waittime){
			//¥¿¥¤¥Ş©`×÷³É
			WaitTimer = new Timer(WaitPlayFunc,"");
			
			// WaitParam ¤ÎÄÚÈİ¤ò¥¯¥ê¥¢
			(Dictionary.clear incontextof WaitParam)();
			
			//¥Ñ¥é¥á©`¥¿¤ò±£´æ¤·¤Æ¤ª¤¯
			WaitParam["file"] = file;
			WaitParam["mode"] = mode;
			WaitParam["time"] = time;
			
			WaitTimer.enabled  = true;
			
			WaitTimer.interval = waittime;
			
			return;
		}
		
		
		
		//¥ë©`¥×¥Õ¥é¥°
		looping = mode;
		
		//media open
		open(file);
		
		//¥Õ¥¡¥¤¥ë±£³Ö
		ResFile = file;
		
		if(time != false)
		{//FADE ÔO¶¨
			
			volume = 0;
			
			//ÔÙÉú
			play();
			
			if(soundtype == "bgm"){
				
				fade((MainWnd.SoundObj.BgmVolume * 1000), time);
				
			}else if(soundtype == "se"){
				
				fade((MainWnd.SoundObj.SeVolume * 1000), time);
				
			}
			
		}else{
		//Í¨³£ÒôÁ¿
			//type¤Ë¤è¤Ã¤Æ·Ö¤«¤ì¤ë
			if(soundtype == "bgm"){
				volume  = MainWnd.SoundObj.BgmVolume   * 1000;
			}else if(soundtype == "se"){
				volume  = MainWnd.SoundObj.SeVolume    * 1000;
			}else if(soundtype == "voice"){
				volume  = MainWnd.SoundObj.VoiceVolume * 1000;
			}else if(soundtype == "system_se"){
				volume  = MainWnd.SoundObj.SystemVolume* 1000;
			}
			
			//ÔÙÉú
			play();
			
		}
		
		
		
		
		return true;
	}
	
	
	
	
	
	/*-----------------------------------------
	¡ğ WaitÔÙÉúévÊı
	-----------------------------------------*/
	function WaitPlayFunc()
	{
		
		//¥¿¥¤¥Ş©`¤òÍ£Ö¹£¦ÆÆ—‰
		WaitTimer.enabled  = false;
		
		invalidate WaitTimer;
		
		WaitTimer = void;
		
		//¥Õ¥¡¥¤¥ë¤òÔÙÉú¤¹¤ë
		FilePlay(WaitParam["file"], WaitParam["mode"], WaitParam["time"]);
	}
	
	
	
	
	
	/*-----------------------------------------
	¡ñstopévÊı
	
	ÒıÊı£º
	
	mode false:normal true:loop
	
	
	ÕhÃ÷£º
	
	Í£Ö¹évÊı
	
	-----------------------------------------*/
	function FileStop(time = false)
	{
		
		
		//Í£Ö¹
		//Wait¤ÏÍ£Ö¹
		if(WaitTimer !== void){
			//¥¿¥¤¥Ş©`¤òÍ£Ö¹£¦ÆÆ—‰
			WaitTimer.enabled  = false;
			
			invalidate WaitTimer;
			
			WaitTimer = void;
		}
		
		
		if(time){
			
			if(soundtype == "bgm"){
				
				volume = MainWnd.SoundObj.BgmVolume * 1000;
				
				fade(0, time);
				
				FadeStopflag = true;
				
			}else{
				
				volume = MainWnd.SoundObj.SeVolume * 1000;
				
				fade(0, time);
				
				FadeStopflag = true;
				
			}
			
		}else{
			
			FadeStopflag = false;
			
			stop();
			
			ResFile = void;
			
			stopFade();
			
			paused = false;
		}
		
		return true;
	}
	
	
	
	
	
	
	
	
	/*-----------------------------------------
	¡ô¥¤¥Ù¥ó¥ÈÈ¡µÃévÊı
	
	ÒıÊı£º
	¤Ê¤·
	
	ÕhÃ÷£º
	Idol×´‘B¤Ëºô¤Ó³ö¤µ¤ì¤ëévÊı
	
	-----------------------------------------*/
	function DefaultAction()
	{
		//¥¨¥ó¥Ç¥£¥ó¥°ÖĞ¤ÏŸoÒ•
		if(f.ending_start)return;
		
		
		//ÔÙÉú½KÁË¤ò¤ß¤Æ´Î¤Ø
		if(SetState(3) != "play")MainWnd.PaserObj.GetTagload();
	}
	
	
	
	
	
	/*-----------------------------------------
	¡ö ¥¯¥ê¥Ã¥¯´ı¤Á
	-----------------------------------------*/
	
	/*-----------------------------------------
	¡ô¥¤¥Ù¥ó¥ÈÈ¡µÃévÊı
	
	ÒıÊı£º
	¤Ê¤·
	
	ÕhÃ÷£º
	Mouse Up¤ò„IÀí¤¹¤ë¥Ï¥ó¥É¥é
	
	-----------------------------------------*/
	function LeftMouseUpAction()
	{
		//¥¨¥ó¥Ç¥£¥ó¥°ÖĞ¤ÏŸoÒ•
		if(f.ending_start)return;
		
		//Í£Ö¹¤·¤Æ´Î¤Ø
		FileStop();
		
		
		
		//´Î¤Î¥¿¥°¤òÈ¡µÃ¤·¤Ë¤¤¤¯
		MainWnd.PaserObj.GetTagload();
	}
	
	
	
	
	
	/*-----------------------------------------
	¡ôRightMouseUpActionévÊı
	
	ÒıÊı£º
	Ÿo¤·
	
	ÕhÃ÷£º
	¤³¤Î¥¯¥é¥¹¥ª¥Ö¥¸¥§¥¯¥È¤ÎRightMouseUpAction
	
	-----------------------------------------*/
	function RightMouseUpAction(){
		
		//¥¨¥ó¥Ç¥£¥ó¥°ÖĞ„IÀí
		if(f.ending_start)return;
			
		//Í£Ö¹¤·¤Æ´Î¤Ø
		FileStop();
		
		//´Î¤Î¥¿¥°¤òÈ¡µÃ¤·¤Ë¤¤¤¯
		MainWnd.PaserObj.GetTagload();
		
	}
	
	
	
	
	/*-----------------------------------------
	¡ñSetStateévÊı
	
	ÒıÊı£º
	
	mode	0:ÔÙÉúTYPE			0:Í¨³£ÔÙÉú 1:loopÔÙÉú
			1:PANÔO¶¨			-100 ¡« 0 ¡« 100
			2:Ò»•rÍ£Ö¹			0:½â³ı 1:Ò»•rÍ£Ö¹
			3:ÔÙÉú×´‘B¤ÎÈ¡µÃ	"play","stop","susppend"
			4:ÔÙÉú•rég¤ÎÈ¡µÃ	
			5:ÒôÁ¿ÔO¶¨			0 ¡« 100
			6:¾tÔÙÉú•rég¤ÎÈ¡µÃ	
	ÕhÃ÷£º
	
	É«¡©¤Ê‚¤òÔO¶¨¤¹¤ë
	
	-----------------------------------------*/
	function SetState(mode, value = 0)
	{
		
		switch(mode){
		case 0:{//ÔÙÉúTYPE			0:Í¨³£ÔÙÉú 1:loopÔÙÉú
			
			looping = value;
			
		}break;
		case 1:{//PANÔO¶¨			-100 ¡« 0 ¡« 100
			
			pan = value;
			
		}break;
		case 2:{//Ò»•rÍ£Ö¹			0:½â³ı 1:Ò»•rÍ£Ö¹
			
			paused = value;
			
		}break;
		case 3:{//ÔÙÉú×´‘B¤ÎÈ¡µÃ	"play","stop","susppend","unload"
			
			if(paused)return "susppend";
			
			return status;
			
		}break;
		case 4:{//ÔÙÉú•rég¤ÎÈ¡µÃ
			
			return position;
			
		}break;
		case 5:{//ÒôÁ¿ÔO¶¨
			
			//type¤Ë¤è¤Ã¤Æ·Ö¤«¤ì¤ë
			if(soundtype == "bgm"){
			//BGM
				MainWnd.SoundObj.BgmVolume  = value;
				
				//MOVIE ¤âBGM¤ËºÏ¤ï¤»¤ë
				MainWnd.SoundObj.MovieVolume= value;
				volume  = MainWnd.SoundObj.BgmVolume   * 1000;
				
			}else if(soundtype == "se"){
			//„¿¹ûÒô
				MainWnd.SoundObj.SeVolume = value;
				volume  = MainWnd.SoundObj.SeVolume    * 1000;
				
			}else if(soundtype == "voice"){
			//ÒôÉùVOLUME
				MainWnd.SoundObj.VoiceVolume = value;
				volume  = MainWnd.SoundObj.VoiceVolume * 1000;
				
			}else if(soundtype == "movie"){
			//MOVIE VOLUME
				MainWnd.SoundObj.MovieVolume = value;
				volume  = MainWnd.SoundObj.MovieVolume * 1000;
				
			}else if(soundtype == "system_se"){
			//SYSTEM„¿¹ûÒô
				MainWnd.SoundObj.SystemVolume = value;
				volume  = MainWnd.SoundObj.SystemVolume * 1000;
			}
			
		}break;
		case 6:{//¾tÔÙÉú•rég¤ÎÈ¡µÃ
			
			return (status != "unload") ? totalTime : 0;
			
		}break;
		}
	}
	
}


@endif
		MainWnd.SoundObj.SeVolume = value;
				volume  = MainWnd.SoundObj.SeVolume    * 1000;
				
			}else if(soundtype == "voice"){
			//éŸ³å£°VOLUME
				MainWnd.SoundObj.VoiceVolume = value;
				volume  = MainWnd.SoundObj.VoiceVolume * 1000;
				
			}else if(soundtype == "movie"){
			//MOVIE VOLUME
				MainWnd.SoundObj.MovieVolume = value;
				volume  = MainWnd.SoundObj.MovieVolume * 1000;
				
			}else if(soundtype == "system_se"){
			//SYSTEMåŠ¹æœéŸ³
				MainWnd.SoundObj.SystemVolume = value;
				volume  = MainWnd.SoundObj.SystemVolume * 1000;
			}
			
		}break;
		case 6:{//ç·å†ç”Ÿæ™‚é–“ã®å–å¾—
			
			return (status != "unload") ? totalTime : 0;
			
		}break;
		}
	}
	
}


@endif
